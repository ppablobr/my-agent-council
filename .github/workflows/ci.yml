name: CI

on:
  pull_request:
  push:
    branches: ["main", "master"]

jobs:
  docs-and-guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Docs link check (relative)
        run: python3 scripts/check_markdown_links.py

      - name: Plan guardrail (PLAN.md ↔ plan.json)
        run: python3 scripts/guardrails/check_plan_files_in_sync.py

      - name: Traceability guardrail (code changes ↔ specs)
        run: python3 scripts/guardrails/check_traceability.py

  node-quality-gates:
    runs-on: ubuntu-latest
    if: ${{ hashFiles('package.json') != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Detect scripts
        id: detect
        run: |
          node - <<'NODE'
          const p = require('./package.json');
          const hasLint = Boolean(p.scripts && p.scripts.lint);
          const hasTest = Boolean(p.scripts && p.scripts.test);
          const fs = require('fs');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `has_lint=${hasLint}\nhas_test=${hasTest}\n`);
          console.log({ hasLint, hasTest });
          NODE

      - name: Run lint
        if: ${{ steps.detect.outputs.has_lint == 'true' }}
        run: npm run -s lint

      - name: Run tests
        if: ${{ steps.detect.outputs.has_test == 'true' }}
        run: npm test --silent
